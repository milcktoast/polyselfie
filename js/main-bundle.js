!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){var d=(a("./utils/function").bindAll,a("./utils/object").extend),e=a("./utils/Looper"),f=a("./sketch/VideoBuffer"),g=a("./sketch/VideoSketch"),h=!1,i=16,j=new f(4*i,3*i),k=new g(j,{nodesMax:80,nodesRemove:10,colors:[[39,25,70],[34,52,106],[0,116,118],[27,182,182],[248,188,21]]}),l=new e(function(a){k.draw()});setTimeout(function(){k.setSize(window.innerWidth,window.innerHeight),k.setRange(200,400)},1);var m=document.body,n=document.getElementById("start");m.appendChild(k.el),d(k.el.style,{position:"absolute",top:"0",left:"0"});var o=function(a){a||(m.className+="is-recording")};h&&(m.appendChild(j.bufferDisplay),d(j.bufferDisplay.style,{position:"absolute",top:"10px",left:"10px",webkitTransform:"scaleX(-1)"}),document.addEventListener("keyup",function(a){switch(a.which){case 82:j.request(o);break;case 32:j.toggle(),l.toggle()}})),n.addEventListener("click",function(a){j.request(o)}),window.addEventListener("resize",function(a){k.setSize(window.innerWidth,window.innerHeight)}),j.play(),l.play()},{"./sketch/VideoBuffer":3,"./sketch/VideoSketch":4,"./utils/Looper":5,"./utils/function":7,"./utils/object":8}],2:[function(a,b,c){b.exports={distanceSq:function(a,b,c,d){var e=c-a,f=d-b;return e*e+f*f}}},{}],3:[function(a,b,c){function d(a,b){this.el=document.createElement("video"),this.buffer=document.createElement("canvas"),this.bufferDisplay=document.createElement("canvas"),this.ctx=this.buffer.getContext("2d"),this.ctxDisplay=this.bufferDisplay.getContext("2d"),this.setSize(a,b),this.pixels=e("f32",4*this.size),this.el.addEventListener("ended",this.onVideoEnd.bind(this))}var e=a("../utils/array").create;b.exports=d,d.prototype={request:function(a){var b=this;navigator.mediaDevices.getUserMedia({video:!0}).then(function(c){b.hasDiff=!1,b.isStreaming=!0,b.stream=c,b.pause(),b.setSource(c),b.play(),a(null)})["catch"](function(b){console.error(b),a(b)})},setSize:function(a,b){var c=this.el,d=this.buffer,e=this.bufferDisplay;this.width=c.width=d.width=e.width=a,this.height=c.height=d.height=e.height=b,this.size=a*b},setSource:function(a,b){if(!b)return void(this.el.srcObject=a);for(var c,d=this.formats,e=0,f=b.length;f>e;e++)if(c=b[e],d[c]){this.el.src=a+"."+c;break}},formats:function(){var a=document.createElement("video");if(!a||!a.canPlayType)return null;var b=a.canPlayType.bind(a);return{mp4:!!b('video/mp4; codecs="mp4v.20.8"'),h264:!(!b('video/mp4; codecs="avc1.42E01E"')&&!b('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')),ogv:!!b('video/ogg; codecs="theora"'),webm:!!b('video/webm; codecs="vp8, vorbis"')}}(),seek:function(a){this.el.currentTime=a},play:function(){return this.isPlaying=!0,this.el.play()},pause:function(){return this.isPlaying=!1,this.el.pause()},toggle:function(){this.isPlaying?this.pause():this.play()},onVideoEnd:function(a){this.seek(0),this.play()},readPixels:function(){var a=this.ctx,b=this.width,c=this.height;return a.drawImage(this.el,0,0,b,c),a.getImageData(0,0,b,c)},forFrameDiff:function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p=a.data,q=this.hasDiff,r=this.pixels,s=(this.points,0),t=b[0],u=b[1];for(d=0,e=p.length;e>d;d+=4)g=p[d],i=p[d+1],h=p[d+2],j=r[d],l=r[d+1],k=r[d+2],m=Math.abs(g-j),o=Math.abs(i-l),n=Math.abs(h-k),p[d]=m,p[d+1]=o,p[d+2]=n,r[d]=g,r[d+1]=i,r[d+2]=h,s+=f=m+o+n,q&&f>t&&u>f&&c(d/4,f);s>0&&(this.ctxDisplay.putImageData(a,0,0),this.hasDiff=!0)}}},{"../utils/array":6}],4:[function(a,b,c){function d(a,b){e(this,"addNode"),f.extend(this,b),this._nodePoolIndex=0,this._nodePool=[],this.nodes=[],this.colors=this.colors||this.defaultColors,this.quadtree=null,this.range=g.create("f32",2),this.context=new k.Context({clear:{red:20/255,green:0,blue:14/255,alpha:1}}),this.gl=this.context.GL,this.el=this.context.domElement,this.video=a,this.context.enableBlend(!0,{equation:this.gl.FUNC_ADD,src:this.gl.SRC_ALPHA,dst:this.gl.ONE}),this.initShader(1e4),this.initPostShader(),this.updateNode=this.nodeUpdater(this.polys,this.colors,this.range)}var e=(a("fs"),a("../utils/function").bindAll),f=a("../utils/object"),g=a("../utils/array"),h=a("../math/vec2"),i=a("d3Quadtree"),j=i().x(function(a){return a[0]}).y(function(a){return a[1]}),k=a("GlowCore"),l=a("GlowPlaneGeometry"),m=a("GlowFloat"),n=!1;b.exports=d,d.prototype={defaultColors:[[100,100,100],[255,255,255]],polyShaderConfig:{vertexShader:"uniform	float screenWidth;\nuniform	float screenHeight;\n\nattribute vec2 vertices;\nattribute vec3 color;\nattribute float opacity;\n\nvarying vec3 vColor;\nvarying float vOpacity;\n\nvoid main() {\n	// vec2 size = vec2(screenWidth, screenHeight);\n	vColor = color;\n	vOpacity = opacity;\n	gl_Position = vec4(vertices.x, vertices.y, 1.0, 1.0);\n}\n",fragmentShader:"#ifdef GL_ES\n	precision highp float;\n#endif\n\nuniform vec2 screenSize;\nuniform	float screenWidth;\nuniform	float screenHeight;\n\nvarying vec3 vColor;\nvarying float vOpacity;\n\nvoid main() {\n	// float x = gl_FragCoord.x / screenSize.x;\n	// float y = gl_FragCoord.y / screenSize.y;\n	gl_FragColor = vec4(vColor / 255.0, vOpacity * 0.03);\n}\n"},postFxShaderConfig:{vertexShader:"attribute vec3 vertices;\nattribute vec2 uvs;\nvarying vec2 uv;\n\nvoid main() {\n	uv = uvs;\n	gl_Position = vec4(vertices.x, vertices.y, 1.0, 1.0);\n}\n",fragmentShader:"#define ITERATIONS 10.0\n\n#ifdef GL_ES\n	precision highp float;\n#endif\n\nuniform float offset;\nuniform float darkness;\n\nuniform float time;\nuniform float blur;\n\n// noise intensity [0, 1]\nuniform float nIntensity;\n// scanlines intensity [0, 1]\nuniform float sIntensity;\n// scanlines count [0, 4096]\nuniform float sCount;\n\nuniform sampler2D tDiffuse;\nvarying vec2 uv;\n\nfloat random(vec3 scale, float seed) {\n	// use the fragment position for a different seed per-pixel\n	return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);\n}\n\nvoid main() {\n	vec4 texel = texture2D(tDiffuse, uv);\n\n	// Vignette\n	// --------\n\n	vec2 vuv = (uv - vec2(0.5)) * vec2(offset);\n	float dark = darkness + darkness * sin(time * 0.1) * cos(time * 0.5) * cos(time * 2.0) * 0.2;\n	texel = vec4(mix(texel.rgb, vec3(1.0 - dark), dot(vuv, vuv)), texel.a);\n\n	// Film grain\n	// ----------\n\n	// noise\n	float dx = uv.x * uv.y * time *  1000.0;\n	dx = mod(mod(dx, 13.0) * mod(dx, 123.0), 0.01);\n	vec3 cResult = texel.rgb + texel.rgb * clamp(0.1 + dx * 100.0, 0.0, 1.0);\n\n	// scanlines\n	vec2 sc = vec2(sin(uv.y * sCount), cos(uv.y * sCount));\n	cResult += texel.rgb * vec3(sc.x, sc.y, sc.x) * sIntensity;\n\n	// interpolate between source and result by intensity\n	cResult = texel.rgb + clamp(nIntensity, 0.0, 1.0) * (cResult - texel.rgb);\n\n	// convert to grayscale\n	// cResult = vec3(cResult.r * 0.3 + cResult.g * 0.59 + cResult.b * 0.11);\n	gl_FragColor = vec4(cResult, texel.a);\n\n	// Blur\n	// ----\n\n	vec4 color = vec4(0.0);\n	float total = 0.0;\n	vec2 delta = vec2(blur);\n\n	// randomize the lookup values to hide the fixed number of samples\n	float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\n\n	for (float t = -ITERATIONS; t <= ITERATIONS; t ++) {\n		float percent = (t + offset - 0.5) / ITERATIONS;\n		float weight = 1.0 - abs(percent);\n\n		color += texture2D(tDiffuse, uv + delta * percent) * weight;\n		total += weight;\n	}\n\n	gl_FragColor += color / total;\n}\n"},initShader:function(a){var b=f.extend({data:{screenWidth:new m(1),screenHeight:new m(1),opacity:g.create("f32",3*a),color:g.create("f32",3*a*3),vertices:g.create("f32",3*a*2)},indices:g.range("ui8",3*a),primitives:this.gl.TRIANGLES,interleave:{color:!1,opacity:!1,vertices:!1},usage:{color:this.gl.DYNAMIC_DRAW,opacity:this.gl.DYNAMIC_DRAW,vertices:this.gl.DYNAMIC_DRAW,primitives:this.gl.DYNAMIC_DRAW}},this.polyShaderConfig);this.polys=new k.Shader(b)},initPostShader:function(){var a=new k.FBO({depth:!0,stencil:!1}),b=f.extend({data:{offset:new m(.25),darkness:new m(4),time:new m(0),blur:new m(.03),nIntensity:new m(.5),sIntensity:new m(.5),sCount:new m(3686.4),tDiffuse:a,vertices:l.vertices(),uvs:l.uvs()},indices:l.indices(),primitives:this.gl.TRIANGLES},this.postFxShaderConfig);this.fbo=a,this.postEffect=new k.Shader(b)},setSize:function(a,b){var c=this.el;this.polys;this.width=c.width=a,this.height=c.height=b,this.context.resize(a,b),this.fbo.resize(a,b),this.size=a*b},setRange:function(a,b){var c=this.range;c[0]=a,c[1]=b},getNodeFromPool:function(){var a=this._nodePool,b=this._nodePoolIndex,c=a[this._nodePoolIndex];return c||(c=a[b]=g.create("f32",3)),this._nodePoolIndex++,c},shiftNodePool:function(a){var b=this._nodePool,c=b.splice(0,a);this._nodePool=b.concat(c),this._nodePoolIndex-=a,n&&console.log(this._nodePool.length)},addNode:function(a,b){var c=this.getNodeFromPool(),d=this.video.width,e=this.video.height;c[0]=Math.abs(a%d/d-1),c[1]=Math.abs(Math.floor(a/d)/e-1),c[2]=b,this.nodes.push(c)},updateQuadtree:function(){this.quadtree=j(this.nodes)},draw:function(){var a=this.video;if(a.isPlaying){var b=this.nodes,c=a.readPixels();a.forFrameDiff(c,this.range,this.addNode),b.length&&(this.updateQuadtree(),n&&console.log(b.length,this._nodePool.length));var d,e,f=this.context,g=this.fbo,h=this.polys,i=this.postEffect,j=h.attributes.vertices,k=h.attributes.color,l=h.attributes.opacity,m=l.data;for(i.time.add(.1),d=0,e=b.length;e>d;d++)this.updateNode(b[d]);for(d=0,e=m.length;e>d;d++)m[d]=Math.max(0,m[d]-.1);j.bufferData(),k.bufferData(),l.bufferData(),f.cache.clear(),g.bind(),f.clear(),h.draw(),g.unbind(),i.draw(),h.draw(),b.length&&this.reset()}},nodeUpdater:function(a,b,c){function d(a,b,c,d,e){return d+(a-b)*(e-d)/(c-b)}function e(a,b){return Math.atan2(b[1]-a[1],b[0]-a[0])}function f(a){return function(b,c){return e(a,b)-e(a,c)}}function g(a){var e=h;(!e||2*e+1>j.length)&&(e=h=0);var f=d(a[2],c[0],c[1],0,b.length-1),g=b[Math.round(f)];j[2*e]=2*a[0]-1,j[2*e+1]=2*a[1]-1,k[3*e]=g[0],k[3*e+1]=g[1],k[3*e+2]=g[2],l[e]=1,h++}var h=0,i=a.attributes,j=i.vertices.data,k=i.color.data,l=i.opacity.data;return function(a){var b,c,d,e,h=a[2]/3e3,i=this.search(this.quadtree,a[0],a[1],h);for(i.sort(f(a)),b=1,c=i.length;c>b;b++)d=i[b-1],e=i[b],g(a),g(d),g(e)}},search:function(a,b,c,d){var e=b-d,f=c-d,g=b+d,i=c+d,j=d*d,k=[];return a.visit(function(a,d,l,m,n){var o=a.point;return o&&h.distanceSq(b,c,o[0],o[1])<=j&&k.push(o),d>=g||l>=i||e>m||f>n}),k},reset:function(){var a=this.nodes,b=Math.max(a.length-this.nodesMax,this.nodesRemove);a.splice(0,b),this.shiftNodePool(b)}}},{"../math/vec2":2,"../utils/array":6,"../utils/function":7,"../utils/object":8,fs:9}],5:[function(a,b,c){function d(a){function b(){c&&(a(),window.requestAnimationFrame(b))}var c=!1;this.pause=function(){c=!1},this.play=function(){c=!0,b()},this.toggle=function(){c=!c,c&&b()}}b.exports=d},{}],6:[function(a,b,c){var d=this,e={i8:"Int8Array",ui8:"Uint8Array",ui8c:"Uint8ClampedArray",i16:"Int16Array",ui16:"Uint16Array",i32:"Int32Array",ui32:"Uint32Array",f32:"Float32Array",f64:"Float64Array"};b.exports={create:function(a,b){var c=d[e[a]||a]||Array;return new c(b)},range:function(a,b){for(var c=this.create(a,b),d=0;b>d;d++)c[d]=d;return c}}},{}],7:[function(a,b,c){var d=Array.prototype.slice;b.exports={bindAll:function(){for(var a,b=arguments[0],c=d.call(arguments,1),e=0,f=c.length;f>e;e++)a=c[e],b[a]=b[a].bind(b)}}},{}],8:[function(a,b,c){b.exports={extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}}},{}],9:[function(a,b,c){},{}]},{},[1]);